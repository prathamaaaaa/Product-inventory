<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Add Product</title>
</head>
<body>
<div th:fragment="content">
    <h1>Add Product Details</h1>
    <a th:href="@{/all?pages=List}">Back to List</a>

    <form action="" method="post" id="dynamicForm">



        <label for="type">Select type</label>
        <select id="type" name="type" onchange="updateForm()">
            <option value="product" selected>Product</option>
            <option value="category">Category</option>
            <option value="subcategory">Subcategory</option>
        </select>
        <br>




        <!-- Product Section -->
        <div id="productContainer">
            <label for="product">Add Product</label>
            <input type="text" class="bg-blue-200" name="product[]" id="product">
            <button type="button" id="addProduct" onclick="addMoreProduct()">Add More</button>
        </div>



        <!-- Category Section (Initially Hidden) -->
        <div id="categoryContainer" style="display: none;">
            <label for="productSelect">Select Product:</label>
            <select id="productSelect" name="productId">
                <option th:each="product : ${products}"
                        th:value="${product.id}"
                        th:text="${product.name}">
                </option>
            </select>
            <br>
            <div id="categoryFields">
                <label>Add Category:</label>
                <input type="text" name="categoryName[]" class="category-input" placeholder="Enter category">
            </div>
            <button type="button" id="addCategory" onclick="addMoreCategory()">Add More Categories</button>
        </div>

        <div id="subcategoryContainer" style="display: none;">
            <label for="subcategoryProduct">Select Product:</label>
            <select id="subcategoryProduct" name="productId" onchange="filterCategories()">
                <option value="">-- Select Product --</option>
                <option th:each="product : ${products}"
                        th:value="${product.id}"
                        th:text="${product.name}">
                </option>
            </select>
            <br>

            <label for="subcategoryCategory">Select Category:</label>
            <select id="subcategoryCategory" name="categoryId">
                <option value="">-- Select Category --</option>
                <option th:each="category : ${categories}"
                        th:value="${category.id}"
                        th:text="${category.name}"
                        th:attr="data-product-id=${category.product.id}">
                </option>
            </select>

            <div id="subCategoryFields">
                <label>Add Subcategory:</label>
                <input type="text" name="subCategoryName[]" class="subcategory-input" placeholder="Enter subcategory">
            </div>
            <button type="button" id="addSubCategory" onclick="addMoreSubCategory()">Add More Subcategories</button>
        </div>

        <button type="submit" id="submitButton">Submit</button>
    </form>

    <script>
        function s(){

            let p = document.getElementById("subcategoryProduct").value;
            console.log(p);
        }
        function updateForm() {
            let type = document.getElementById("type").value;
            let productContainer = document.getElementById("productContainer");
            let categoryContainer = document.getElementById("categoryContainer");
            let form = document.getElementById("dynamicForm");

            if (type === 'category') {
                productContainer.style.display = "none";
                categoryContainer.style.display = "block";
                subcategoryContainer.style.display = "none";

                form.action = "/save-category";
            } else if (type === 'subcategory') {
            productContainer.style.display = "none";
            categoryContainer.style.display = "none";
            subcategoryContainer.style.display = "block";
            form.action = "/save-subcategory";
        } else {
            productContainer.style.display = "block";
            categoryContainer.style.display = "none";
            subcategoryContainer.style.display = "none";
            form.action = "/save-product";
        }
        }

        function addMoreProduct() {
            let container = document.getElementById("productContainer");
            let newInput = document.createElement("input");
            newInput.type = "text";
            newInput.name = "product[]";
            newInput.className = "bg-blue-200";
            newInput.placeholder = "Enter another product";

            container.appendChild(document.createElement("br"));
            container.appendChild(newInput);
        }

        function addMoreCategory() {
            let container = document.getElementById("categoryFields");
            let newInput = document.createElement("input");
            newInput.type = "text";
            newInput.name = "categoryName[]";
            newInput.className = "category-input";
            newInput.placeholder = "Enter another category";

            container.appendChild(document.createElement("br"));
            container.appendChild(newInput);
        }
        function addMoreSubCategory() {
        let container = document.getElementById("subCategoryFields");
        let newInput = document.createElement("input");
        newInput.type = "text";
        newInput.name = "subCategoryName[]";
        newInput.placeholder = "Enter another subcategory";
        container.appendChild(document.createElement("br"));
        container.appendChild(newInput);
    }
      function filterCategories() {
        let selectedProductId = document.getElementById("subcategoryProduct").value;
        let categoryOptions = document.querySelectorAll("#subcategoryCategory option");

        categoryOptions.forEach(option => {
            let categoryProductId = option.getAttribute("data-product-id");

            if (!categoryProductId || categoryProductId === selectedProductId) {
                option.style.display = "block"; // ✅ Show categories belonging to the selected product
            } else {
                option.style.display = "none"; // ❌ Hide categories that don't match the product
            }
        });

        // ✅ Auto-select the first visible category if available
        let firstVisible = document.querySelector("#subcategoryCategory option[style='display: block;']");
        if (firstVisible) {
            document.getElementById("subcategoryCategory").value = firstVisible.value;
        } else {
            document.getElementById("subcategoryCategory").value = ""; // Reset selection if no match
        }
    }

    document.addEventListener("DOMContentLoaded", filterCategories);
        document.addEventListener("DOMContentLoaded", updateForm);
    </script>

</div>
</body>
</html>
